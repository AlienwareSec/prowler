{
  "Provider": "openstack",
  "CheckID": "compute_instance_config_drive_enabled",
  "CheckTitle": "Compute instances have config drive enabled",
  "CheckType": [],
  "ServiceName": "compute",
  "SubServiceName": "",
  "ResourceIdTemplate": "",
  "Severity": "low",
  "ResourceType": "OpenStackInstance",
  "ResourceGroup": "compute",
  "Description": "**OpenStack compute instances** (VMs) are evaluated to verify that **config drive** is enabled. Config drive provides metadata and user data via a virtual CD-ROM device instead of the metadata service (169.254.169.254). This improves security by eliminating network-based metadata access, which can be vulnerable to SSRF attacks and metadata service exploitation.",
  "Risk": "Compute instances without config drive rely on the metadata service (169.254.169.254), which is vulnerable to SSRF attacks that can extract instance metadata, user data, and credentials. Attackers exploiting SSRF vulnerabilities in applications can query the metadata service to steal cloud credentials, SSH keys, and sensitive configuration data. The metadata service is also vulnerable to spoofing attacks in compromised networks and can become unavailable, preventing instance initialization. Config drive eliminates this network attack surface by providing metadata via a virtual CD-ROM device.",
  "RelatedUrl": "",
  "AdditionalURLs": [
    "https://docs.openstack.org/nova/queens/user/config-drive.html",
    "https://docs.openstack.org/ironic/latest/install/configdrive.html",
    "https://cloudinit.readthedocs.io/en/latest/reference/datasources/configdrive.html"
  ],
  "Remediation": {
    "Code": {
      "CLI": "# Note: Config drive must be set at instance creation time\nopenstack server create --config-drive true --image <image_id> --flavor <flavor_id> --key-name <keypair> <instance_name>\n\n# For existing instances: rebuild with config drive (WARNING: destructive)\nopenstack server rebuild --config-drive true <instance_id> <image_id>",
      "NativeIaC": "",
      "Other": "**For new instances:**\n1. Navigate to **Compute > Instances > Launch Instance**\n2. In the **Configuration** or **Advanced Options** tab, enable **Config Drive**\n3. Complete instance launch wizard\n4. Verify with `openstack server show <instance_id> | grep config_drive`\n\n**For existing instances:**\n- Config drive cannot be added to running instances without rebuild\n- Rebuild operation is destructive (preserves ephemeral disks but requires downtime)\n- Create snapshot before rebuild: `openstack server image create <instance_id> --name backup-snapshot`\n- Alternative: use cloud-init datasource fallback order in user data",
      "Terraform": "```hcl\n# Terraform: enable config drive for compute instance\nresource \"openstack_compute_instance_v2\" \"instance\" {\n  name            = \"secure-instance\"\n  image_id        = var.image_id\n  flavor_id       = var.flavor_id\n  key_pair        = var.key_pair_name\n  security_groups = [\"default\"]\n  # Enable config drive for secure metadata injection\n  config_drive    = true\n\n  network {\n    name = var.network_name\n  }\n\n  # Optional: cloud-init will automatically use config drive if available\n  user_data = <<-EOF\n    #cloud-config\n    datasource_list: [ConfigDrive, OpenStack]\n  EOF\n}\n```"
    },
    "Recommendation": {
      "Text": "Implement **config drive** for enhanced metadata security:\n- **Enable config drive** for all new instances to eliminate metadata service attack surface\n- Use config drive in **air-gapped** or **isolated networks** where metadata service is unavailable\n- Combine with **metadata service firewall rules** blocking 169.254.169.254 from application workloads\n- Implement **IMDSv2-style authentication** if metadata service is required (vendor-specific)\n- Review **cloud-init configuration** to prioritize config drive datasource\n- Monitor for **SSRF vulnerabilities** in applications that could exploit metadata service\n- Use **read-only config drive** (default) to prevent tampering from guest OS\n- Document config drive usage in **security baselines** and deployment runbooks\n- Consider **automation** (e.g., policy-as-code) to enforce config drive for sensitive workloads",
      "Url": "https://hub.prowler.com/check/compute_instance_config_drive_enabled"
    }
  },
  "Categories": [
    "trust-boundaries"
  ],
  "DependsOn": [],
  "RelatedTo": [],
  "Notes": "Config drive must be enabled at instance creation time and cannot be added to existing instances without rebuild. Some OpenStack deployments may not support config drive (e.g., bare metal provisioning). Config drive is read-only from the guest OS perspective."
}
